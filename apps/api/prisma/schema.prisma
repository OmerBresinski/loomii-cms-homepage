// Prisma schema for AI CMS

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum ProjectStatus {
  pending
  analyzing
  ready
  error
  archived
}

enum ElementType {
  text
  heading
  paragraph
  image
  link
  button
  section
  list
  navigation
  footer
  hero
  card
  custom
}

enum EditStatus {
  draft
  pending_review
  approved
  rejected
}

enum EditType {
  modify  // Change existing content
  add     // Add new item to group
  delete  // Remove item from group
}

enum PullRequestStatus {
  open
  merged
  closed
  draft
  conflict
}

enum TeamRole {
  owner
  admin
  editor
  viewer
}

enum OrgRole {
  owner
  admin
  member
}

// Models
model User {
  id                String   @id @default(uuid())
  clerkId           String   @unique
  email             String   @unique
  name              String?
  avatarUrl         String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  edits              Edit[]
  pullRequests       PullRequest[]
  teamMemberships    TeamMember[]
  invitedMembers     TeamMember[]        @relation("InvitedBy")
  sessions           Session[]
  orgMemberships     OrganizationMember[]

  @@map("users")
}

// Organization - synced with Clerk Organizations
model Organization {
  id                String   @id @default(uuid())
  clerkOrgId        String   @unique // Clerk organization ID
  name              String
  slug              String   @unique
  logoUrl           String?
  // GitHub integration at org level
  githubInstallationId String?  // GitHub App installation ID
  githubAccessToken    String?  // OAuth token for GitHub API
  githubOrgName        String?  // GitHub organization/user name
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  members  OrganizationMember[]
  projects Project[]

  @@map("organizations")
}

model OrganizationMember {
  id             String   @id @default(uuid())
  organizationId String
  userId         String
  role           OrgRole  @default(member)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId])
  @@map("organization_members")
}

model Project {
  id             String        @id @default(uuid())
  organizationId String
  createdById    String        // User who created the project
  name           String
  githubRepo     String
  githubBranch   String        @default("main")
  rootPath       String        @default("") // Root path within the repo (for monorepos, e.g., "apps/web")
  deploymentUrl  String?
  status         ProjectStatus @default(pending)
  lastAnalyzedAt DateTime?
  analysisError  String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  // Relations
  organization  Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  sections      Section[]
  elements      Element[]
  elementGroups ElementGroup[]
  pullRequests  PullRequest[]
  teamMembers   TeamMember[]

  @@map("projects")
}

model Section {
  id          String   @id @default(uuid())
  projectId   String
  pageUrl     String?  // Page route this section belongs to (e.g., "/", "/about")
  name        String   // AI-generated name like "Hero Section"
  description String?
  sourceFile  String?  // Primary file this section is from
  startLine   Int?     // Approximate line range
  endLine     Int?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  project  Project        @relation(fields: [projectId], references: [id], onDelete: Cascade)
  elements Element[]
  groups   ElementGroup[]

  @@map("sections")
}

model ElementGroup {
  id            String   @id @default(uuid())
  projectId     String
  sectionId     String?
  pageUrl       String?  // Page route this group belongs to (e.g., "/", "/about")
  name          String   // "Comparison Items Left", "Navigation Links"
  description   String?
  sourceFile    String
  startLine     Int      // First item starts here
  endLine       Int      // Last item ends here
  itemCount     Int      // Current number of items
  templateCode  String   @db.Text  // Code template for one item
  placeholders  Json?    // Array of placeholder names/descriptions
  containerInfo Json?    // Parent element info (tag, attributes)
  confidence    Float    @default(0.8)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  project  Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  section  Section?  @relation(fields: [sectionId], references: [id])
  elements Element[]

  @@map("element_groups")
}

model Element {
  id            String      @id @default(uuid())
  projectId     String
  sectionId     String?     // Group elements into sections
  groupId       String?     // Link to ElementGroup for repeatable items
  groupIndex    Int?        // Position within group (0, 1, 2...)
  name          String
  type          ElementType
  selector      String?     // Optional - only set for DOM-scraped elements
  xpath         String?
  sourceFile    String?     // File path in repo for source-analyzed elements
  sourceLine    Int?        // Line number in source file
  sourceColumn  Int?
  currentValue  String?     @db.Text
  sourceContext String?     @db.Text  // 3 lines before/after for diff view
  schema        Json?
  parentId      String?
  pageUrl       String
  screenshotUrl String?
  confidence    Float       @default(0)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  // Relations
  project  Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  section  Section?      @relation(fields: [sectionId], references: [id])
  group    ElementGroup? @relation(fields: [groupId], references: [id])
  parent   Element?      @relation("ElementHierarchy", fields: [parentId], references: [id])
  children Element[]     @relation("ElementHierarchy")
  edits    Edit[]

  @@map("elements")
}

model Edit {
  id            String     @id @default(uuid())
  elementId     String
  userId        String
  editType      EditType   @default(modify)
  oldValue      String?    @db.Text
  newValue      String     @db.Text
  oldHref       String?    // For link elements - original href
  newHref       String?    // For link elements - new href
  templateData  Json?      // For 'add': filled template content with placeholders
  deletedCode   String?    @db.Text  // For 'delete': the code being removed
  status        EditStatus @default(draft)
  pullRequestId String?
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  // Relations
  element     Element      @relation(fields: [elementId], references: [id], onDelete: Cascade)
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  pullRequest PullRequest? @relation(fields: [pullRequestId], references: [id])

  @@map("edits")
}

model PullRequest {
  id             String            @id @default(uuid())
  projectId      String
  userId         String
  githubPrNumber Int
  githubPrUrl    String
  title          String
  description    String?           @db.Text
  status         PullRequestStatus @default(open)
  mergedAt       DateTime?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  edits   Edit[]

  @@map("pull_requests")
}

model TeamMember {
  id        String   @id @default(uuid())
  projectId String
  userId    String
  role      TeamRole @default(viewer)
  invitedBy String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  inviter User?   @relation("InvitedBy", fields: [invitedBy], references: [id])

  @@unique([projectId, userId])
  @@map("team_members")
}

model Session {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

// Analysis job tracking
model AnalysisJob {
  id          String   @id @default(uuid())
  projectId   String
  status      String   @default("queued") // queued, running, completed, failed
  progress    Int      @default(0)
  totalPages  Int      @default(0)
  error       String?  @db.Text
  startedAt   DateTime?
  completedAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("analysis_jobs")
}

